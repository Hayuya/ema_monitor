name: EMAæ‰¿èªãƒ»æ²»é¨“ç›£è¦–ã‚¢ãƒ—ãƒª

on:
  schedule:
    # æ¯æ™‚0åˆ†ã«å®Ÿè¡Œ (UTCæ™‚é–“)
    - cron: '0 * * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼ˆè©³ç´°ãƒ­ã‚°å‡ºåŠ›ï¼‰'
        required: false
        default: 'false'
        type: boolean

jobs:
  monitor-ema:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: ğŸ Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ’¾ ä¾å­˜é–¢ä¿‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: ğŸ“¦ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ—‚ï¸ å‰å›ãƒã‚§ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ
      uses: actions/cache@v3
      with:
        path: last_check.txt
        key: ema-monitor-lastcheck-${{ github.run_number }}
        restore-keys: |
          ema-monitor-lastcheck-
    
    - name: ğŸ¥ EMAç›£è¦–ã‚¢ãƒ—ãƒªã®å®Ÿè¡Œ
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        CHECK_INTERVAL_HOURS: 1
        MAX_NEWS_ITEMS: 15
        DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
      run: |
        echo "ğŸš€ EMAç›£è¦–ã‚¢ãƒ—ãƒªã‚’é–‹å§‹ã—ã¾ã™..."
        echo "â° å®Ÿè¡Œæ™‚åˆ»: $(date)"
        
        if [ "$DEBUG_MODE" = "true" ]; then
          echo "ğŸ” ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œä¸­..."
          python -u main.py
        else
          python main.py
        fi
        
        echo "âœ… EMAç›£è¦–ã‚¢ãƒ—ãƒªãŒå®Œäº†ã—ã¾ã—ãŸ"
    
    - name: ğŸ“Š å®Ÿè¡Œçµæœã®ç¢ºèª
      if: always()
      run: |
        echo "ğŸ“‹ å®Ÿè¡Œãƒ­ã‚°ã®æ¦‚è¦:"
        if [ -f "ema_monitor.log" ]; then
          echo "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
          echo "æœ€å¾Œã®10è¡Œ:"
          tail -10 ema_monitor.log
        else
          echo "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi
        
        if [ -f "last_check.txt" ]; then
          echo "å‰å›ãƒã‚§ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«: $(cat last_check.txt)"
        fi
    
    - name: ğŸ”— Discordé€šçŸ¥ãƒ†ã‚¹ãƒˆï¼ˆåˆå›å®Ÿè¡Œæ™‚ï¼‰
      if: github.run_number == 1
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        python -c "
        import requests, json, os
        from datetime import datetime
        
        webhook_url = os.getenv('DISCORD_WEBHOOK_URL')
        if webhook_url:
            payload = {
                'embeds': [{
                    'title': 'ğŸ¤– EMAç›£è¦–ã‚¢ãƒ—ãƒªèµ·å‹•å®Œäº†',
                    'description': 'GitHub Actionsã«ã‚ˆã‚‹è‡ªå‹•ç›£è¦–ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸï¼\n\nğŸ“… æ¯æ™‚0åˆ†ã«æ–°è–¬æ‰¿èªãƒ»æ²»é¨“æƒ…å ±ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™\nğŸ¯ cbp501ãªã©ã®æ²»é¨“æƒ…å ±ã‚‚ç›£è¦–å¯¾è±¡ã§ã™',
                    'color': 0x00FF00,
                    'timestamp': datetime.utcnow().isoformat(),
                    'footer': {
                        'text': 'EMA Monitor - GitHub Actions'
                    },
                    'fields': [
                        {
                            'name': 'ğŸ”„ å®Ÿè¡Œé–“éš”',
                            'value': '1æ™‚é–“ã”ã¨',
                            'inline': True
                        },
                        {
                            'name': 'ğŸ¯ ç›£è¦–å¯¾è±¡',
                            'value': 'EMAæ‰¿èªæƒ…å ±ãƒ»æ²»é¨“æƒ…å ±',
                            'inline': True
                        }
                    ]
                }]
            }
            
            response = requests.post(webhook_url, json=payload)
            if response.status_code == 204:
                print('âœ… èµ·å‹•é€šçŸ¥ã®é€ä¿¡ã«æˆåŠŸã—ã¾ã—ãŸ')
            else:
                print(f'âŒ èµ·å‹•é€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—: {response.status_code}')
        else:
            print('âŒ Discord Webhook URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“')
        "
    
    - name: ğŸ“¤ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ï¼‰
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: error-logs-${{ github.run_number }}
        path: |
          ema_monitor.log
          *.txt
        retention-days: 7
    
    - name: ğŸ’¾ ãƒã‚§ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
      if: always()
      uses: actions/cache/save@v3
      with:
        path: last_check.txt
        key: ema-monitor-lastcheck-${{ github.run_number }}
