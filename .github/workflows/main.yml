# GitHub Actions Workflow: CBP501 Phase III Trial Monitoring

name: CBP501ä¸‰ç›¸æ²»é¨“ç›£è¦–

on:
  schedule:
    # [å¤‰æ›´] æ¯æ™‚0åˆ†ã«ç›£è¦–ã‚’å®Ÿè¡Œ (UTC)
    - cron: '0 * * * *'
    # [è¿½åŠ ] æ¯æ—¥21:00 (JST) ã«å®šæœŸå ±å‘Šã‚’å®Ÿè¡Œ (UTC 12:00)
    - cron: '0 12 * * *'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼ˆè©³ç´°ãƒ­ã‚°å‡ºåŠ›ï¼‰'
        required: false
        default: 'false'
        type: boolean
      force_status_report:
        description: 'å¼·åˆ¶ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å ±å‘Š'
        required: false
        default: 'false'
        type: boolean

jobs:
  monitor-cbp501:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸ Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ğŸ’¾ ä¾å­˜é–¢ä¿‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: ğŸ“¦ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ—‚ï¸ å‰å›ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ
      uses: actions/cache@v4
      with:
        path: |
          execution_counter.txt
          cbp501_status.txt
        key: cbp501-monitor-data-${{ github.run_number }}
        restore-keys: |
          cbp501-monitor-data-

    - name: ğŸ§¬ CBP501ç›£è¦–ã‚¢ãƒ—ãƒªã®å®Ÿè¡Œ
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        # [å‰Šé™¤] STATUS_REPORT_INTERVALã¯å®šæœŸå ±å‘Šã‚¹ãƒ†ãƒƒãƒ—ã«ç§»è¡Œã—ãŸãŸã‚å‰Šé™¤
        DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
        FORCE_STATUS_REPORT: ${{ github.event.inputs.force_status_report || 'false' }}
      run: |
        echo "ğŸ§¬ CBP501ä¸‰ç›¸æ²»é¨“ç›£è¦–ã‚¢ãƒ—ãƒªã‚’é–‹å§‹ã—ã¾ã™..."
        echo "â° å®Ÿè¡Œæ™‚åˆ»: $(date)"
        echo "ğŸ”„ å®Ÿè¡Œå›æ•°: ${{ github.run_number }}"
        echo "ğŸ¯ ç›£è¦–å¯¾è±¡: CBP501ä¸‰ç›¸æ²»é¨“é–‹å§‹æƒ…å ±"
        
        if [ "$DEBUG_MODE" = "true" ]; then
          echo "ğŸ” ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œä¸­..."
          python -u main.py
        else
          python main.py
        fi
        
        echo "âœ… CBP501ç›£è¦–ã‚¢ãƒ—ãƒªãŒå®Œäº†ã—ã¾ã—ãŸ"

    - name: ğŸ“Š å®Ÿè¡Œçµæœã®ç¢ºèª
      if: always()
      run: |
        echo "ğŸ“‹ å®Ÿè¡Œãƒ­ã‚°ã®æ¦‚è¦:"
        if [ -f "cbp501_monitor.log" ]; then
          echo "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
          echo "æœ€å¾Œã®10è¡Œ:"
          tail -10 cbp501_monitor.log
        else
          echo "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi
        
        if [ -f "execution_counter.txt" ]; then
          echo "å®Ÿè¡Œå›æ•°: $(cat execution_counter.txt)"
        fi
        
        if [ -f "cbp501_status.txt" ]; then
          echo "CBP501ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $(cat cbp501_status.txt)"
        fi

    - name: 'ğŸš€ èµ·å‹•é€šçŸ¥ (åˆå›å®Ÿè¡Œæ™‚)'
      # [å¤‰æ›´] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚·ãƒ³ãƒ—ãƒ«åŒ–
      if: github.run_number == 1
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        python -c "
        import requests, json, os
        from datetime import datetime
        webhook_url = os.getenv('DISCORD_WEBHOOK_URL')
        if webhook_url:
            payload = {
                'embeds': [{
                    'title': 'âœ… CBP501ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ  èµ·å‹•å®Œäº†',
                    'description': 'CBP501ä¸‰ç›¸æ²»é¨“ã®ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°æ™‚ã«é€šçŸ¥ã—ã¾ã™ã€‚',
                    'color': 0x2ECC71,
                    'timestamp': datetime.utcnow().isoformat(),
                    'footer': { 'text': 'CBP501 Monitor' }
                }]
            }
            requests.post(webhook_url, json=payload)
        "

    - name: 'ğŸ“œ å®šæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å ±å‘Š (JST 21:00)'
      # [è¿½åŠ ] æ¯æ—¥å®šæ™‚ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å ±å‘Šã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—
      if: github.event.schedule == '0 12 * * *'
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        python -c "
        import requests, json, os
        from datetime import datetime, timezone, timedelta

        # JSTã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’å®šç¾©
        JST = timezone(timedelta(hours=+9))

        # ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’èª­ã¿è¾¼ã‚€
        try:
            with open('cbp501_status.txt', 'r', encoding='utf-8') as f:
                status = f.read().strip()
        except FileNotFoundError:
            status = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸æ˜'

        webhook_url = os.getenv('DISCORD_WEBHOOK_URL')
        if webhook_url:
            embed = {
                'title': 'ğŸŒ™ CBP501ç›£è¦– å®šæœŸå ±å‘Š',
                'description': f'**æ²»é¨“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: `{status}`**\n\nå¼•ãç¶šãç›£è¦–ã‚’ç¶™ç¶šã—ã¾ã™ã€‚',
                'color': 0x3498DB,
                'timestamp': datetime.utcnow().isoformat(),
                'footer': {
                    'text': f'CBP501 Monitor | {datetime.now(JST).strftime(\"%Y-%m-%d %H:%M\")} JST'
                }
            }
            payload = {'embeds': [embed]}
            response = requests.post(webhook_url, json=payload)
            if 200 <= response.status_code < 300:
                print('âœ… å®šæœŸå ±å‘Šã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚')
            else:
                print(f'âŒ å®šæœŸå ±å‘Šã®é€ä¿¡ã«å¤±æ•—: {response.status_code}, {response.text}')
        else:
            print('âŒ Discord Webhook URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚')
        "

    - name: ğŸ“¤ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ï¼‰
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: cbp501-error-logs-${{ github.run_number }}
        path: |
          cbp501_monitor.log
          *.txt
        retention-days: 7

    - name: ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
      if: always()
      uses: actions/cache/save@v4
      with:
        path: |
          execution_counter.txt
          cbp501_status.txt
        key: cbp501-monitor-data-${{ github.run_number }}